<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     @author Cristian Spiescu                                                                
     ====================================================================== -->
<project name="project" default="default" basedir="..">
	<description>
            description
    </description>

	<!-- ================================= 
          target: default              
         ================================= -->
	<target name="default" description="Add the class files to jar, and copies it to the Arduino tools folder.">
		<loadfile property="version" srcfile="src/main/resources/flowerino-plugin-version.txt"></loadfile>
		<jar destfile="build/FlowerPlatformPlugin.jar" basedir="target/classes">
			<fileset dir="../../tiny-http-server/tiny-http-server/bin" />
			<fileset dir="../flower-platform-rapp-manager/target/classes" />
			<manifest>
				<attribute name="Implementation-Version" value="${version}"/>
			</manifest>
		</jar>
		<copy file="build/FlowerPlatformPlugin.jar" todir="${user.home}/Documents/Arduino/tools/FlowerPlatformPlugin/tool">
		</copy>
	</target>

	<target name="clean">
		<delete>
			<fileset dir="build" includes="**/*"/>
		</delete>
	</target>
				
	<target name="zip" description="Builds and creates a ZIP that contains the right dir structure to use when unzipping in ARDUINO_SKETCHBOOK_DIR/tools" depends="default">
		<zip destfile="build/FlowerPlatformPlugin_v${version}.zip">
			<zipfileset dir="build" includes="FlowerPlatformPlugin.jar" prefix="FlowerPlatformPlugin/tool"/>
			<zipfileset dir="lib" includes="*" prefix="FlowerPlatformPlugin/tool"/>
		</zip>
	</target>

	
	<!-- Test runner for Arduino IDE v1.6.7 suite -->
	<target name="runTestsBase">
		<junit printsummary="yes" haltonfailure="yes" fork="true" jvm="${arduino_base_dir}/java/bin/javaw.exe">
			
			<jvmarg value="-Dsun.java2d.d3d=false"/>
			<jvmarg value="-Xms128M"/>
			<jvmarg value="-Xmx512M"/>
			
			<jvmarg value="-DAPP_DIR=&quot;${arduino_base_dir}&quot;"/>
			
			<!-- Dependencies needed for running tests -->
			<classpath>
				<pathelement location="test_deps/junit-4.12.jar"/>
				<pathelement location="test_deps/hamcrest-core-1.3.jar"/>
				<pathelement location="test_deps/junit-toolbox-2.2.jar"/>
				<pathelement location="test_deps/commons-io-2.4.jar"/>
				<pathelement location="test/resources/"/>
			</classpath>
			
			<!-- The regular, and test classes from the current project (i.e. Flowerino) -->
			<classpath location="bin"/>
			
			<!-- The link with the tiny-http-server project -->
			<classpath location="../../tiny-http-server/tiny-http-server/bin" />
			
			<!-- The Arduino IDE jars, needed for actually launching Arduino IDE. -->
			<classpath>
				<fileset dir="${arduino_base_dir}/lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
			
			<test name="${suite_test}" haltonfailure="no" outfile="result">
				<formatter type="xml" usefile="false"/>
			</test>
		</junit>
	</target>
	
	<!-- Runs the whole test suite against an Arduino v1.6.7 IDE -->
	<target name="runTests_1_6_7">
		<property name="arduino_base_dir" value="D:/Arduino_IDEs/arduino-1.6.7"/>
		<property name="suite_test" value="org.flowerplatform.flowerino_plugin.ArduinoIde_v167_TestSuiteLauncher"/>
		<antcall target="runTestsBase" />		
	</target>
	
	<!-- Runs the whole test suite against an Arduino v1.6.8 IDE -->
	<target name="runTests_1_6_8">
		<property name="arduino_base_dir" value="D:/Arduino_IDEs/arduino-1.6.8"/>
		<property name="suite_test" value="org.flowerplatform.flowerino_plugin.ArduinoIde_v168_TestSuiteLauncher"/>
		<antcall target="runTestsBase" />		
	</target>
	
</project>
